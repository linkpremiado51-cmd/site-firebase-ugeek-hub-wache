<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AniGeekNews</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #ffffff;
      font-family: 'Inter', sans-serif;
      color: #121212;
      line-height: 1.5;
    }

    header {
      padding: 12px 17.5px;
      background: white;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .nav-container {
      max-width: 770px;
      margin: 0 auto;
      display: flex;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 800;
      text-decoration: none;
      color: #121212;
    }

    .destaque-secao {
      margin-bottom: 56px;
      border-bottom: 1px solid #eaeaea;
      padding-bottom: 14px;
    }

    .destaque-padding {
      padding: 0 17.5px;
      max-width: 770px;
      margin: 0 auto;
    }

    .destaque-titulo {
      font-size: clamp(18.2px, 3.5vw, 30.8px);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.7px;
      margin: 0;
      cursor: pointer;
    }

    .destaque-categoria {
      color: var(--tema-cor);
      font-size: 7.7px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.4px;
      margin-bottom: 10.5px;
      display: flex;
      align-items: center;
      gap: 5.6px;
    }

    .destaque-resumo {
      font-size: clamp(11.2px, 1.4vw, 13.3px);
      line-height: 1.6;
      color: #444;
      margin-bottom: 7px;
    }

    .btn-ver-artigo {
      display: inline-flex;
      align-items: center;
      gap: 5.6px;
      color: var(--tema-cor);
      text-decoration: none;
      font-size: 9.1px;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 17.5px;
    }

    .destaque-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(105px, 1fr));
      gap: 14px;
      background: #f8f9fa;
      padding: 10.5px;
      border-left: 2.8px solid var(--tema-cor);
      margin-bottom: 17.5px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 2.8px;
    }

    .info-label {
      font-size: 7px;
      text-transform: uppercase;
      font-weight: 700;
      color: #888;
    }

    .info-valor {
      font-size: 9.1px;
      font-weight: 600;
    }

    .destaque-media iframe,
    .noticia-completa iframe {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: none;
      display: block;
    }

    .premium-actions-bar {
      display: flex;
      align-items: center;
      padding: 8.4px 10.5px;
      gap: 7px;
      border-top: 1px solid #f0f0f0;
      background: #fff;
    }

    .btn-premium-icon {
      background: #f8f9fa;
      border: 1px solid transparent;
      padding: 5.6px 9.8px;
      border-radius: 14px;
      font-size: 8.4px;
      font-weight: 700;
      color: #444;
      display: flex;
      align-items: center;
      gap: 5.6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .hero-topo-container {
      width: 100%;
      background: #fff;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .hero-topo-img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
      max-height: 450px;
    }

    .hero-topo-desc {
      padding: 15px;
      font-size: 13px;
      color: #555;
      line-height: 1.6;
      background: #fdfdfd;
      border-bottom: 1px solid #eee;
      font-style: italic;
    }

    #pagination-control {
      text-align: center;
      padding: 21px;
      display: none;
    }

    .btn-paginacao-geek {
      background: #212529;
      color: white;
      border: none;
      padding: 8.4px 21px;
      border-radius: 21px;
      font-weight: bold;
      cursor: pointer;
      font-size: 9.1px;
      text-transform: uppercase;
      letter-spacing: 0.35px;
      box-shadow: 0 2.8px 7px rgba(0,0,0,0.2);
    }

    .ficha-categoria {
      background: #fff9f0;
      border-radius: 6px;
      margin: 6px 0;
      padding: 7px 10px;
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 9px;
      border-left: 4px solid;
    }

    .ficha-categoria img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .ficha-categoria .ficha-info {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .ficha-categoria .info-item {
      display: flex;
      align-items: baseline;
      gap: 3px;
      white-space: nowrap;
    }

    .ficha-categoria .info-label {
      font-weight: 600;
    }

    /* NOTIFICAÇÕES */
    #notificacao-novo-artigo {
      position: fixed;
      top: 14px;
      right: 14px;
      background: #2563eb;
      color: #fff;
      padding: 10.5px 17.5px;
      border-radius: 5.6px;
      box-shadow: 0 7px 21px rgba(0,0,0,0.2);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 8.4px;
      transform: translateX(150%);
      transition: transform 0.5s;
    }

    #notificacao-novo-artigo.mostrar {
      transform: translateX(0);
    }

    #toast-copiado {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%) translateY(150%);
      background: #4caf50;
      color: white;
      padding: 7px 14px;
      border-radius: 2.8px;
      font-size: 9.1px;
      font-weight: 600;
      z-index: 9999;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    #toast-copiado.mostrar {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* MODAL */
    #modal-noticia {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      z-index: 99999;
      padding: 14px;
      overflow-y: auto;
    }

    #modal-conteudo {
      background: white;
      color: #121212;
      max-width: 630px;
      margin: 28px auto;
      padding: 21px;
      border-radius: 5.6px;
      position: relative;
    }

    #modal-fechar {
      position: absolute;
      top: 10.5px;
      right: 10.5px;
      background: #eee;
      border: none;
      width: 22.4px;
      height: 22.4px;
      border-radius: 50%;
      font-size: 12.6px;
      cursor: pointer;
    }

    #modal-video {
      width: 100%;
      aspect-ratio: 16 / 9;
      margin: 14px 0;
      border: none;
    }

    .noticia-completa {
      margin-top: 20px;
      font-size: 14px;
      line-height: 1.7;
    }

    .noticia-completa h3 {
      font-size: 18px;
      font-weight: 700;
      margin: 24px 0 12px;
      color: #1a1a1a;
    }

    .noticia-completa p {
      margin-bottom: 16px;
      color: #333;
    }

    @media (max-width: 768px) {
      .destaque-info-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="nav-container">
      <a href="#" class="logo">AniGeekNews<span style="font-weight:400; opacity:0.5;">v3</span></a>
    </div>
  </header>

  <!-- NOTIFICAÇÃO -->
  <div id="notificacao-novo-artigo">
    <i class="fa-solid fa-satellite-dish"></i>
    <div>
      <div style="font-size: 7px; font-weight: 800; opacity: 0.8; text-transform: uppercase;">Atualização via Cloud</div>
      <div id="novo-artigo-titulo" style="font-size: 9.1px; font-weight: 700;">Conectando ao AniGeek...</div>
    </div>
  </div>

  <!-- HERO -->
  <div id="hero-area"></div>

  <!-- CONTEÚDO DINÂMICO -->
  <div id="container-principal"></div>

  <!-- PAGINAÇÃO -->
  <div id="pagination-control">
    <button id="btn-carregar-mais" class="btn-paginacao-geek">
      <i class="fa-solid fa-chevron-down"></i> Carregar mais conteúdos
    </button>
  </div>

  <!-- TOAST -->
  <div id="toast-copiado">Link copiado!</div>

  <!-- MODAL -->
  <div id="modal-noticia">
    <div id="modal-conteudo">
      <button id="modal-fechar" onclick="window.fecharModal()">×</button>

      <div id="modal-capa-container" style="margin: -20px -20px 15px -20px; display: none;">
        <img id="modal-capa-img" src="" style="width: 100%; aspect-ratio: 16 / 9; object-fit: cover; border-radius: 12px 12px 0 0;" />
      </div>

      <div id="modal-header-layout">
        <div id="modal-titulo" class="destaque-titulo" style="margin-top: 0;"></div>
        <div id="modal-categoria" class="destaque-categoria"></div>
      </div>
      <p id="modal-resumo" class="destaque-resumo"></p>
      <a id="modal-link" class="btn-ver-artigo" target="_blank"><i class="fa-solid fa-book-open"></i> Ler artigo completo</a>
      <div id="modal-ficha" class="destaque-info-grid"></div>
      <iframe id="modal-video" allowfullscreen style="width: 100%; aspect-ratio: 16 / 9; border: none; border-radius: 8px; margin-top: 15px;"></iframe>
      <div id="modal-noticia-completa" class="noticia-completa"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let todasAsNoticias = [];
    let noticiasExibidas = 5;

    function limparEspacos(url) {
      return url ? url.trim() : url;
    }

    window.shareNews = (titulo, url) => {
      if (navigator.share) {
        navigator.share({ title: titulo, url }).catch(console.error);
      } else {
        window.copiarLink(url);
      }
    };

    window.copiarLink = async (url) => {
      try {
        await navigator.clipboard.writeText(url);
        const toast = document.getElementById('toast-copiado');
        toast.classList.add('mostrar');
        setTimeout(() => toast.classList.remove('mostrar'), 2500);
      } catch (err) {
        console.error("Erro ao copiar:", err);
      }
    };

    window.fecharModal = () => {
      document.getElementById('modal-noticia').style.display = 'none';
      document.getElementById('modal-video').src = "";
      document.getElementById('modal-noticia-completa').innerHTML = "";
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.pushState({}, '', url);
    };

    async function incrementarVisualizacao(idNoticia) {
      try {
        const noticiaRef = doc(db, "analises", idNoticia);
        await updateDoc(noticiaRef, { visualizacoes: increment(1) });
      } catch (err) {
        console.error("Erro ao incrementar visualização:", err);
      }
    }

    window.abrirNoticiaEmModal = (noticia) => {
      document.getElementById('modal-titulo').innerText = noticia.titulo;
      document.getElementById('modal-categoria').innerHTML = `<i class="fa-solid fa-video"></i> ${noticia.categoria}`;
      document.getElementById('modal-resumo').innerText = noticia.resumo;
      document.getElementById('modal-link').href = noticia.linkArtigo;

      const modalCapaContainer = document.getElementById('modal-capa-container');
      const modalCapaImg = document.getElementById('modal-capa-img');
      const imgCapa = noticia.capaNoticia || noticia.capaUrl;

      if (imgCapa) {
        modalCapaImg.src = limparEspacos(imgCapa);
        modalCapaContainer.style.display = 'block';
      } else {
        modalCapaContainer.style.display = 'none';
      }

      let fichaHtml = "";
      if (noticia.ficha) {
        fichaHtml = noticia.ficha.map(item =>
          `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`
        ).join('');
      }
      document.getElementById('modal-ficha').innerHTML = fichaHtml;

      if (noticia.fichaCategoria) {
        const modalFichaCat = `
        <div class="ficha-categoria" style="border-left: 4px solid ${noticia.fichaCategoria.cor};">
            <img src="${limparEspacos(noticia.fichaCategoria.perfilImg)}" alt="Imagem do editor">
            <div class="ficha-info">
                ${noticia.fichaCategoria.info.map(item => `
                    <div class="info-item">
                        <span class="info-label">${item.label}:</span>
                        <span class="info-valor">${item.valor}</span>
                    </div>
                `).join('')}
            </div>
        </div>`;
        document.getElementById('modal-ficha').insertAdjacentHTML('beforebegin', modalFichaCat);
      }

      document.getElementById('modal-video').src = limparEspacos(noticia.videoPrincipal);
      
      // Renderizar noticia_completa no modal
      const noticiaCompletaEl = document.getElementById('modal-noticia-completa');
      if (noticia.noticia_completa) {
        noticiaCompletaEl.innerHTML = noticia.noticia_completa;
        noticiaCompletaEl.style.display = 'block';
      } else {
        noticiaCompletaEl.style.display = 'none';
        noticiaCompletaEl.innerHTML = '';
      }

      document.getElementById('modal-noticia').style.display = 'block';
      setTimeout(() => incrementarVisualizacao(noticia.id), 50);
    };

    window.curtirNoticia = async (idNoticia) => {
      try {
        const spanCurtidas = document.querySelector(`#artigo-${idNoticia} .num-like`);
        if (spanCurtidas) {
          let atual = parseInt(spanCurtidas.innerText) || 0;
          spanCurtidas.innerText = atual + 1;
        }
        const noticiaRef = doc(db, "analises", idNoticia);
        await updateDoc(noticiaRef, { curtidas: increment(1) });
      } catch (err) {
        console.error("Erro ao curtir:", err);
      }
    };

    function verificarNoticiaNaUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      if (id && todasAsNoticias.length > 0) {
        const noticia = todasAsNoticias.find(n => n.id === id);
        if (noticia) window.abrirNoticiaEmModal(noticia);
      }
    }

    function renderizarHero(primeiraNoticia) {
      const heroArea = document.getElementById('hero-area');
      if (!heroArea || !primeiraNoticia) return;
      if (primeiraNoticia.capaUrl) {
        heroArea.innerHTML = `
          <div class="hero-topo-container">
            <img src="${limparEspacos(primeiraNoticia.capaUrl)}" class="hero-topo-img" alt="Capa">
            ${primeiraNoticia.capaDesc ? `<div class="hero-topo-desc">${primeiraNoticia.capaDesc}</div>` : ''}
          </div>
        `;
        heroArea.style.display = 'block';
      } else {
        heroArea.style.display = 'none';
      }
    }

    function renderizarNoticias() {
      const container = document.getElementById('container-principal');
      const btnPaginacao = document.getElementById('pagination-control');
      if (!container) return;

      const baseUrl = window.location.origin + window.location.pathname;
      if (todasAsNoticias.length > 0) renderizarHero(todasAsNoticias[0]);

      const listaParaExibir = todasAsNoticias.slice(0, noticiasExibidas);
      listaParaExibir.forEach(news => {
        if (document.getElementById(`artigo-${news.id}`)) return;

        const imgFeed = news.capaNoticia || news.capaUrl;
        const capaHTML = imgFeed ? `
          <div class="noticia-capa" style="margin: -15px -15px 15px -15px;">
            <img src="${limparEspacos(imgFeed)}" style="width: 100%; aspect-ratio: 16 / 9; border-radius: 12px 12px 0 0; object-fit: cover; display: block;">
          </div>` : '';

        let fichaCategoriaHtml = '';
        if (news.fichaCategoria) {
          fichaCategoriaHtml = `
          <div class="ficha-categoria" style="border-left: 4px solid ${news.fichaCategoria.cor};">
            <img src="${limparEspacos(news.fichaCategoria.perfilImg)}" alt="Imagem do editor">
            <div class="ficha-info">
              ${news.fichaCategoria.info.map(item => `
                <div class="info-item">
                  <span class="info-label">${item.label}:</span>
                  <span class="info-valor">${item.valor}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
        }

        let noticiaCompletaHTML = '';
        if (news.noticia_completa) {
          noticiaCompletaHTML = `<div class="noticia-completa">${news.noticia_completa}</div>`;
        }

        const shareUrl = `${baseUrl}?id=${encodeURIComponent(news.id)}`;
        const html = `
        <article class="destaque-secao" id="artigo-${news.id}" style="--tema-cor: ${news.cor}">
          <div class="destaque-padding">
            ${capaHTML}
            <div class="destaque-categoria"><i class="fa-solid fa-hashtag"></i> ${news.categoria}</div>
            <h2 class="destaque-titulo" onclick='window.abrirNoticiaEmModal(${JSON.stringify(news).replace(/'/g, "&apos;")})'>${news.titulo}</h2>
            ${fichaCategoriaHtml}
            <p class="destaque-resumo">${news.resumo}</p>
            <a href="${news.linkArtigo}" class="btn-ver-artigo" target="_blank"><i class="fa-solid fa-book-open"></i> Ver artigo completo</a>
            <div class="destaque-info-grid">
              ${news.ficha ? news.ficha.map(item => `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`).join('') : ''}
            </div>
          </div>
          <div class="destaque-media">
            <iframe id="player-${news.id}" src="${limparEspacos(news.videoPrincipal)}" allowfullscreen style="width: 100%; aspect-ratio: 16 / 9; border: none;"></iframe>
          </div>
          ${noticiaCompletaHTML}
          <div class="premium-actions-bar">
            <button class="btn-premium-icon" onclick="curtirNoticia('${news.id}')">
              <i class="fa-regular fa-thumbs-up"></i> Útil (<span class="num-like">${news.curtidas || 0}</span>)
            </button>
            <button class="btn-premium-icon" onclick="window.shareNews('${news.titulo.replace(/'/g, "\\'")}', '${shareUrl}')">
              <i class="fa-solid fa-share-nodes"></i> Compartilhar
            </button>
            <button class="btn-premium-icon btn-stats">
              <i class="fa-solid fa-chart-column"></i>
              <span class="stats-num num-view">${news.visualizacoes || 0}</span>
            </button>
          </div>
          ${news.resumo2 ? `<div class="destaque-padding"><p class="destaque-resumo">${news.resumo2}</p></div>` : ''}
        </article>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });

      btnPaginacao.style.display = noticiasExibidas < todasAsNoticias.length ? 'block' : 'none';
    }

    document.getElementById('btn-carregar-mais').onclick = () => {
      noticiasExibidas += 5;
      renderizarNoticias();
    };

    onSnapshot(collection(db, "analises"), (snapshot) => {
      todasAsNoticias = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      todasAsNoticias.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      if (todasAsNoticias.length > 0) {
        document.getElementById('novo-artigo-titulo').innerText = todasAsNoticias[0].titulo;
        document.getElementById('notificacao-novo-artigo').classList.add('mostrar');
        setTimeout(() => document.getElementById('notificacao-novo-artigo').classList.remove('mostrar'), 3000);
      }
      renderizarNoticias();
      verificarNoticiaNaUrl();
    });
  </script>
</body>
</html>
