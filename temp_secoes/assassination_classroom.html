<body>
  <div class="destaque-wrapper">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <div id="notificacao-novo-artigo">
      <i class="fa-solid fa-satellite-dish"></i>
      <div>
        <div style="font-size: 7px; font-weight: 800; opacity: 0.8; text-transform: uppercase;">Atualização via Cloud</div>
        <div id="novo-artigo-titulo" style="font-size: 9.1px; font-weight: 700;">Conectando Ao AniGeek...</div>
      </div>
    </div>

    <div id="ad-slot-top" class="ad-container-anigeek"></div>
    <div id="hero-area"></div>
    <div id="container-principal"></div>
    <div id="ad-slot-bottom" class="ad-container-anigeek"></div>

    <div id="pagination-control" style="text-align: center; padding: 21px; display: none;">
        <button id="btn-carregar-mais" class="btn-paginacao-geek">
            <i class="fa-solid fa-chevron-down"></i> Carregar mais conteúdos
        </button>
    </div>

    <div id="notificacao-video">
      <div style="flex: 1;">
        <div style="font-size: 7px; font-weight: 800; opacity: 0.6; text-transform: uppercase;">Deseja assistir?</div>
        <div id="notif-titulo" style="font-size: 9.1px; font-weight: 700;">Título</div>
      </div>
      <button class="btn-confirmar-video" id="btn-confirmar">Confirmar</button>
      <i class="fa-solid fa-xmark" style="cursor:pointer; padding: 3.5px;" onclick="window.fecharNotif()"></i>
    </div>

    <div id="toast-copiado">Link copiado para o AniGeek!</div>

    <style>
      .ad-container-anigeek { text-align: center; margin: 15px 0; overflow: hidden; min-height: 50px; }
      .ad-container-anigeek img { max-width: 100%; border-radius: 8px; cursor: pointer; }
      .player-overlay-ad {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          z-index: 10; cursor: pointer; background: transparent;
      }
      .destaque-media { position: relative; }
      #container-principal { min-height: 200px; }
      .destaque-secao { transition: opacity 0.3s ease; }
    </style>
<!-- CSS global apenas em standalone -->
<script>
(function(){
  const isStandalone =
    !document.referrer ||
    !document.referrer.includes('linkpremiado51-cmd.github.io/AniGeekNewsv2');

  if (isStandalone) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = '/AniGeekNewsv2/css/global.css'; // caminho do seu global.css
    document.head.appendChild(link);
  }
})();
</script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, getDoc, setDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
        authDomain: "anigeeknews.firebaseapp.com",
        projectId: "anigeeknews",
        storageBucket: "anigeeknews.firebasestorage.app",
        messagingSenderId: "769322939926",
        appId: "1:769322939926:web:6eb91a96a3f74670882737",
        measurementId: "G-G5T8CCRGZT"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let todasAsNoticias = [];
      
      /**
       * SINCRONIZAÇÃO: Pega o valor definido no index.html.
       * Se for uma sessão nova, o padrão é 5.
       */
      let noticiasExibidas = window.noticiasExibidas || 5; 
      
      let playerAlvo = '';
      let urlAlvo = '';
      let linkPropaganda = "https://www.effectivegatecpm.com/u1isyicizb?key=66934bf68fc6093a89704779bb57cce3";
      let playersAdList = new Set(); 

      // --- SISTEMA DE TRACKING ---
      function getVisitorId() {
          let vid = localStorage.getItem('anigeek_vid');
          if (!vid) {
              vid = crypto.randomUUID ? crypto.randomUUID() : 'visitor-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
              localStorage.setItem('anigeek_vid', vid);
          }
          return vid;
      }

      window.registrarInteracao = async (docId, tipoAcao) => {
          try {
              const vid = getVisitorId();
              const ref = doc(db, "anigeeknews.web.app/animes_filmes_series_games_noticias/assassination_classroom", docId, "visitantes", vid);
              await setDoc(ref, {
                  lastActive: serverTimestamp(),
                  actions: arrayUnion({ type: tipoAcao, ts: Date.now() })
              }, { merge: true });
          } catch (e) { console.error("Tracking falhou:", e); }
      };

      function injectAdSafe(containerId, content) {
          const container = document.getElementById(containerId);
          if (!container || !content) return;
          container.innerHTML = '';
          const range = document.createRange();
          range.selectNode(container);
          const fragment = range.createContextualFragment(content);
          container.appendChild(fragment);
      }

      function limparEspacos(url) { return url ? url.trim() : url; }

      // --- HANDLERS DE UI E PERSISTÊNCIA ---
      window.handlePlayerAd = (playerId, linkArtigo) => {
          if (!playersAdList.has(playerId)) {
              playersAdList.add(playerId); 
              const idLimpo = playerId.replace('player-', '');
              
              // SALVA O ID DO ARTIGO: Para o index.html saber onde voltar o scroll
              window.lastArticleId = idLimpo;
              if (window.saveStateGlobal) window.saveStateGlobal();

              window.registrarInteracao(idLimpo, 'player_click');
              const linkFinal = (linkArtigo && linkArtigo.trim() !== "") ? linkArtigo : linkPropaganda;
              window.open(linkFinal, '_blank'); 
              const overlay = document.querySelector(`.overlay-player-${idLimpo}`);
              if (overlay) overlay.remove();
          }
      };

      window.shareNews = (titulo, url) => {
        if (navigator.share) {
          navigator.share({ title: 'AniGeek: ' + titulo, text: 'Confira no AniGeek:', url: url }).catch(console.error);
        } else { window.copiarLink(url); }
      };

      window.copiarLink = async (url) => {
        try {
          await navigator.clipboard.writeText(url);
          const toast = document.getElementById('toast-copiado');
          toast.classList.add('mostrar');
          setTimeout(() => toast.classList.remove('mostrar'), 2500);
        } catch (err) { console.error("Erro copiar:", err); }
      };

      window.pedirTroca = (idPlayer, idVideo, titulo, cor) => {
        playerAlvo = idPlayer;
        const entrada = limparEspacos(idVideo);
        urlAlvo = entrada.startsWith('http') ? entrada : `https://www.youtube.com/embed/${entrada}?autoplay=1`;
        const notif = document.getElementById('notificacao-video');
        const notifTitulo = document.getElementById('notif-titulo');
        if(notifTitulo) notifTitulo.innerText = titulo;
        notif.style.setProperty('--notif-cor', cor);
        notif.classList.add('visivel');
      };

      window.fecharNotif = () => { document.getElementById('notificacao-video').classList.remove('visivel'); };

      const btnConfirmar = document.getElementById('btn-confirmar');
      if(btnConfirmar) {
          btnConfirmar.onclick = () => {
            const player = document.getElementById(playerAlvo);
            if (player) {
                player.src = urlAlvo;
                const newsId = playerAlvo.split('-')[1];
                incrementarVisualizacao(newsId);
            }
            window.fecharNotif();
          };
      }

      async function incrementarVisualizacao(idNoticia) {
        try {
          const noticiaRef = doc(db, "anigeeknews.web.app/animes_filmes_series_games_noticias/assassination_classroom", idNoticia);
          await updateDoc(noticiaRef, { visualizacoes: increment(1) });
        } catch(err) {}
      }

      window.curtirNoticia = async (idNoticia) => {
        try {
          const noticiaRef = doc(db, "anigeeknews.web.app/animes_filmes_series_games_noticias/assassination_classroom", idNoticia);
          await updateDoc(noticiaRef, { curtidas: increment(1) });
        } catch(err) {}
      };

      function verificarNoticiaNaUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (!id) return;
        const artigo = document.getElementById(`artigo-${id}`);
        if (artigo) {
          artigo.scrollIntoView({ behavior: 'smooth', block: 'start' });
          artigo.classList.add('destacado');
          setTimeout(() => artigo.classList.remove('destacado'), 3000);
          const url = new URL(window.location);
          url.searchParams.delete('id');
          window.history.replaceState({}, '', url);
        }
      }

      async function injetarComentariosDinamicos() {
        const containers = document.querySelectorAll('.container-comentarios-dinamico');
        if (containers.length === 0) return;
        try {
          if (!window.comentariosCarregados) {
              await import('./comentarios/comentarios.js');
              window.comentariosCarregados = true;
          }
        } catch (err) { console.error("Erro scripts comentarios", err); }
      }

      function renderizarHero(primeiraNoticia) {
          const heroArea = document.getElementById('hero-area');
          if (!heroArea || !primeiraNoticia || !primeiraNoticia.capaUrl) return;
          heroArea.innerHTML = `
              <div class="hero-topo-container">
                  <img src="${limparEspacos(primeiraNoticia.capaUrl)}" class="hero-topo-img" alt="Capa Principal">
                  ${primeiraNoticia.capaDesc ? `<div class="hero-topo-desc">${primeiraNoticia.capaDesc}</div>` : ''}
              </div>`;
      }

      // --- CORE DE RENDERIZAÇÃO ---
      function renderizarNoticias() {
        const container = document.getElementById('container-principal');
        const btnPaginacao = document.getElementById('pagination-control');
        if (!container) return;

        container.innerHTML = ''; 
        const baseUrl = window.location.origin + window.location.pathname;
        if (todasAsNoticias.length > 0) renderizarHero(todasAsNoticias[0]);

        const listaParaExibir = todasAsNoticias.slice(0, noticiasExibidas);

        listaParaExibir.forEach(news => {
          const shareUrl = `${baseUrl}?id=${encodeURIComponent(news.id)}`;
          const imgFeed = news.capaNoticia || news.capaUrl;
          const overlayEstilo = playersAdList.has(`player-${news.id}`) ? 'display:none;' : '';

          const html = `
          <article class="destaque-secao" id="artigo-${news.id}" style="--tema-cor: ${news.cor}" onclick="window.lastArticleId='${news.id}'">
            <div class="destaque-padding">
              ${imgFeed ? `<div class="noticia-capa" style="margin: -15px -15px 15px -15px;"><img src="${limparEspacos(imgFeed)}" style="width: 100%; aspect-ratio: 16 / 9; border-radius: 12px 12px 0 0; object-fit: cover; display: block;"></div>` : ''}
              <div class="destaque-categoria"><i class="fa-solid fa-hashtag"></i> ${news.categoria}</div>
              <div class="destaque-header">
                <h2 class="destaque-titulo">${news.titulo}</h2>
                <div class="menu-opcoes-container" tabindex="0">
                  <button class="btn-tres-pontos"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                  <div class="dropdown-conteudo header-dropdown">
                    <a href="#" onclick="event.preventDefault(); window.copiarLink('${shareUrl}');">Copiar Link</a>
                    <a href="#" onclick="event.preventDefault(); window.shareNews('${news.titulo}', '${shareUrl}');">Compartilhar</a>
                  </div>
                </div>
              </div>

              ${news.fichaCategoria ? `
              <div class="ficha-categoria" style="border-left: 4px solid ${news.fichaCategoria.cor};">
                  <img src="${limparEspacos(news.fichaCategoria.perfilImg)}">
                  <div class="ficha-info">
                      ${news.fichaCategoria.info ? news.fichaCategoria.info.map(item => `
                          <div class="info-item"><span class="info-label">${item.label}:</span> <span class="info-valor">${item.valor}</span></div>`).join('') : ''}
                  </div>
              </div>` : ''}

              <p class="destaque-resumo">${news.resumo}</p>
              <a href="${news.linkArtigo}" class="btn-ver-artigo" target="_blank"><i class="fa-solid fa-book-open"></i> Ver artigo completo</a>
              
              <div class="destaque-info-grid">
                ${news.ficha ? news.ficha.map(item => `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`).join('') : ''}
              </div>
            </div>

            <div class="destaque-media">
              <div class="player-overlay-ad overlay-player-${news.id}" style="${overlayEstilo}" onclick="handlePlayerAd('player-${news.id}', '${news.linkPropagandaArtigo || ''}')"></div>
              <iframe id="player-${news.id}" src="${limparEspacos(news.videoPrincipal)}" allowfullscreen style="width: 100%; aspect-ratio: 16 / 9; border: none;" loading="lazy"></iframe>
            </div>

            <div class="premium-actions-bar">
                <button class="btn-premium-icon" onclick="curtirNoticia('${news.id}')"><i class="fa-regular fa-thumbs-up"></i> Útil (${news.curtidas || 0})</button>
                <button class="btn-premium-icon" onclick="window.shareNews('${news.titulo}', '${shareUrl}')"><i class="fa-solid fa-share-nodes"></i></button>
                <button class="btn-premium-icon"><i class="fa-solid fa-chart-column"></i> ${news.visualizacoes || 0}</button>
            </div>

            <div class="carrossel-temas">
              <div class="carrossel-header"><span class="temas-label">Vídeos Relacionados</span></div>
              <div class="temas-scroll-wrapper"><div class="temas-container">
                  ${news.relacionados ? news.relacionados.map(rel => `
                    <div class="tema-card" onclick="window.pedirTroca('player-${news.id}', '${rel.idVid}', '${rel.titulo}', '${news.cor}')">
                      <img src="${limparEspacos(rel.thumb)}" class="tema-thumb" loading="lazy">
                      <div class="tema-titulo">${rel.titulo}</div>
                    </div>`).join('') : ''}
              </div></div>
            </div>

            <div class="secao-produtos-banner">
              <div class="banner-header"><i class="fa-solid fa-cart-shopping"></i> Recomendados</div>
              <div class="banner-lista">
                  ${news.produtos ? news.produtos.map(prod => `
                    <a href="${limparEspacos(prod.link)}" target="_blank" class="banner-produto-item" onclick="window.registrarInteracao('${news.id}', 'ad_click')">
                      <div class="banner-img-box"><img src="${limparEspacos(prod.img)}" class="banner-thumb"></div>
                      <div class="banner-info"><div class="banner-titulo">${prod.nome}</div><div class="banner-link-fake">Ver na loja</div></div>
                    </a>`).join('') : ''}
              </div>
            </div>

            <div id="ad-artigo-${news.id}" class="ad-container-anigeek"></div>
            <div class="container-comentarios-dinamico" data-noticia-id="${news.id}"></div>
          </article>`;
          
          container.insertAdjacentHTML('beforeend', html);
          if(news.bannerAd) injectAdSafe(`ad-artigo-${news.id}`, news.bannerAd);
        });

        injetarComentariosDinamicos();
        btnPaginacao.style.display = noticiasExibidas < todasAsNoticias.length ? 'block' : 'none';
        
        // SINCRONIZAÇÃO GLOBAL: Avisa o index.html quantas notícias o usuário tem abertas
        window.noticiasExibidas = noticiasExibidas;
        if (window.saveStateGlobal) window.saveStateGlobal();
      }

      document.getElementById('btn-carregar-mais').onclick = () => {
          noticiasExibidas += 5;
          renderizarNoticias();
      };

      async function carregarConfiguracoesAds() {
        onSnapshot(doc(db, "configuracoes", "ads"), (snap) => {
          if(snap.exists()) {
              const d = snap.data();
              if(d.linkPropaganda) linkPropaganda = d.linkPropaganda;
              if(d.bannerTopo) injectAdSafe('ad-slot-top', d.bannerTopo);
              if(d.bannerFundo) injectAdSafe('ad-slot-bottom', d.bannerFundo);
          }
        });
      }

      function carregarTudoRealTime() {
        onSnapshot(collection(db, "anigeeknews.web.app/animes_filmes_series_games_noticias/assassination_classroom"), (snapshot) => {
          todasAsNoticias = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          todasAsNoticias.sort((a, b) => (a.ordem || 999) - (b.ordem || 999));
          if(todasAsNoticias.length > 0) document.getElementById('novo-artigo-titulo').innerText = todasAsNoticias[0].titulo;
          renderizarNoticias();
          
          // Verifica se há um ID na URL para scroll automático
          setTimeout(verificarNoticiaNaUrl, 150);
        });
      }

      carregarConfiguracoesAds();
      carregarTudoRealTime();
    </script>
  </div>
</body>
