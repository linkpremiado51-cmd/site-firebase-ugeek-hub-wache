<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AniGeek Studio Enterprise ‚Äî v14.0 Executive Edition</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@0.343.0/dist/umd/lucide.js"></script>
  
  <style>
    :root {
      /* Paleta Executiva Premium */
      --primary-50: #f0f5ff;
      --primary-100: #e0e7ff;
      --primary-500: #4f46e5;
      --primary-600: #4338ca;
      --primary-700: #3730a3;
      --primary-800: #312e81;
      
      --neutral-50: #fafafa;
      --neutral-100: #f5f5f5;
      --neutral-200: #e5e5e5;
      --neutral-300: #d4d4d4;
      --neutral-400: #a3a3a3;
      --neutral-500: #737373;
      --neutral-600: #525252;
      --neutral-700: #404040;
      --neutral-800: #262626;
      --neutral-900: #171717;
      
      --surface-50: #fcfcfd;
      --surface-100: #f8f9fc;
      --surface-200: #f1f3f8;
      
      --success-500: #10b981;
      --warning-500: #f59e0b;
      --danger-500: #ef4444;
      --analytics-500: #8b5cf6;
      --ops-500: #ec4899;
      --accent-500: #0ea5e9;
      
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 16px;
      
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Tema Padr√£o - Mantendo compatibilidade com c√≥digo original */
      --primary: var(--primary-500);
      --primary-dark: var(--primary-700);
      --secondary: var(--neutral-900);
      --accent: var(--accent-500);
      --success: var(--success-500);
      --danger: var(--danger-500);
      --warning: var(--warning-500);
      --analytics: var(--analytics-500);
      --ops: var(--ops-500);
      
      --bg: var(--surface-100);
      --surface: var(--neutral-50);
      --border: var(--neutral-300);
      --text-main: var(--neutral-900);
      --text-muted: var(--neutral-600);
      
      --elevation-1: var(--shadow-sm);
      --elevation-2: var(--shadow-md);
      --elevation-3: var(--shadow-lg);
      --elevation-4: var(--shadow-xl);
    }

    /* Dark Mode Executivo */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1115;
        --surface: #14171d;
        --surface-raised: #1a1e24;
        --border: #252a33;
        --border-strong: #333944;
        --text-main: #f0f2f8;
        --text-secondary: #cbd0dc;
        --text-muted: #8a91a1;
        --text-placeholder: #5a6275;
      }
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-size: 12px;
      line-height: 1.4;
      overflow-x: hidden;
      transition: var(--transition-normal);
    }

    /* Header Executivo */
    .header-enterprise {
      background: var(--secondary);
      color: white;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-enterprise h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: -0.025em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-enterprise span {
      font-size: 9px;
      background: var(--primary);
      padding: 4px 8px;
      border-radius: 4px;
      letter-spacing: 0.5px;
    }

    /* Modais Premium */
    .generic-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.92);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 520px;
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      box-shadow: var(--elevation-4);
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface-100);
      font-weight: 700;
      font-size: 14px;
    }

    .modal-header button {
      background: var(--neutral-200);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .modal-header button:hover {
      background: var(--neutral-300);
    }

    .modal-body {
      overflow-y: auto;
      flex: 1;
      padding: 16px;
    }

    /* Container Principal */
    .painel-container {
      max-width: 1150px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 180px;
    }

    /* Busca IA Premium */
    .smart-search-area {
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius-lg);
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: var(--elevation-2);
      transition: var(--transition-normal);
    }

    .smart-search-area:hover {
      box-shadow: var(--elevation-3);
      border-color: var(--primary-600);
    }

    .search-row {
      display: flex;
      gap: 10px;
    }

    .search-row input {
      flex: 1;
      padding: 12px 16px;
      border: 1.5px solid var(--border);
      border-radius: var(--border-radius-md);
      font-size: 14px;
      background: var(--surface);
      color: var(--text-main);
      transition: var(--transition-fast);
    }

    .search-row input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .btn-search {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 24px;
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 100px;
    }

    .btn-search:hover {
      background: var(--primary-600);
      transform: translateY(-1px);
    }

    .btn-search:active {
      transform: translateY(0);
    }

    .results-dropdown {
      background: var(--surface);
      border: 1px solid var(--border);
      max-height: 280px;
      overflow-y: auto;
      margin-top: 10px;
      display: none;
      border-radius: var(--border-radius-md);
      box-shadow: var(--elevation-2);
    }

    .result-item {
      padding: 14px;
      border-bottom: 1px solid var(--neutral-200);
      cursor: pointer;
      transition: var(--transition-fast);
      font-size: 13px;
    }

    .result-item:hover {
      background: var(--primary-50);
      border-left: 3px solid var(--primary);
      padding-left: 11px;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    /* Cards Estilizados Premium */
    .secao-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-lg);
      padding: 18px;
      margin-bottom: 14px;
      position: relative;
      box-shadow: var(--elevation-1);
      transition: var(--transition-normal);
    }

    .secao-card:hover {
      box-shadow: var(--elevation-2);
      transform: translateY(-1px);
    }

    .secao-card h3 {
      margin: 0 0 14px 0;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--neutral-200);
      padding-bottom: 10px;
      font-weight: 800;
      letter-spacing: 0.05em;
    }

    .toggle-btn {
      position: absolute;
      right: 16px;
      top: 14px;
      background: var(--surface-100);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: var(--border-radius-sm);
      font-size: 9px;
      font-weight: 800;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .toggle-btn:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    .grid-compact {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .campo-grupo {
      margin-bottom: 12px;
      position: relative;
    }

    .campo-grupo label {
      font-weight: 700;
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 6px;
      display: block;
      letter-spacing: 0.05em;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--border-radius-md);
      font-size: 13px;
      outline: none;
      background: var(--surface);
      color: var(--text-main);
      transition: var(--transition-fast);
      font-family: 'IBM Plex Sans', sans-serif;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
    }

    .ai-chip {
      flex: 1;
      padding: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-md);
      font-size: 10px;
      text-align: center;
      cursor: pointer;
      font-weight: 800;
      transition: var(--transition-fast);
    }

    .ai-chip:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    .ai-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-inspect {
      position: absolute;
      right: 10px;
      top: 26px;
      background: var(--surface-100);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: var(--border-radius-sm);
      color: var(--primary);
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .btn-inspect:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    .inspect-viewer {
      margin-top: 12px;
      background: var(--neutral-900);
      border-radius: var(--border-radius-md);
      overflow: hidden;
      display: none;
      width: 100%;
      aspect-ratio: 16/9;
      border: 2px solid var(--neutral-800);
    }

    .inspect-viewer iframe, .inspect-viewer img {
      width: 100%;
      height: 100%;
      border: none;
      object-fit: cover;
    }

    .btn-add {
      padding: 12px;
      font-size: 11px;
      font-weight: 800;
      border: 2px dashed var(--border);
      border-radius: var(--border-radius-md);
      background: var(--surface-100);
      color: var(--text-muted);
      width: 100%;
      cursor: pointer;
      margin-bottom: 10px;
      transition: var(--transition-fast);
    }

    .btn-add:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      color: var(--primary-700);
    }

    .item-flex {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .btn-remover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 8px 12px;
      border-radius: var(--border-radius-md);
      font-weight: 800;
      cursor: pointer;
      transition: var(--transition-fast);
      min-width: 40px;
    }

    .btn-remover:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    /* A√ß√µes Fixas Premium */
    .acoes-wrapper {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 16px 24px 16px;
      z-index: 1001;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    }

    .acoes {
      display: flex;
      gap: 10px;
    }

    .btn-main {
      padding: 14px;
      border: none;
      border-radius: var(--border-radius-md);
      font-weight: 800;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-fast);
      letter-spacing: 0.025em;
      min-width: 48px;
    }

    .btn-save {
      background: var(--primary);
      color: white;
      flex: 2;
    }

    .btn-save:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
    }

    .btn-ops {
      background: var(--ops);
      color: white;
      flex: 1;
    }

    .btn-ops:hover {
      background: #db2777;
      transform: translateY(-2px);
    }

    .btn-delete {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      flex: 0.5;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.15);
      transform: scale(1.1);
    }

    .btn-sec {
      background: var(--secondary);
      color: white;
      flex: 1;
    }

    .btn-sec:hover {
      background: #0c1424;
      transform: translateY(-2px);
    }

    .status {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 28px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 800;
      z-index: 3000;
      display: none;
      color: white;
      box-shadow: var(--elevation-3);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translate(-50%, -20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    /* Contador de caracteres */
    .char-counter {
      font-size: 9px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 4px;
      font-weight: 600;
    }

    .char-counter.warning {
      color: var(--danger);
      font-weight: 700;
    }

    /* Organiza√ß√£o de cole√ß√µes em pastas */
    .collection-folder {
      background: var(--surface-100);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-md);
      padding: 12px;
      margin-bottom: 12px;
      transition: var(--transition-fast);
    }

    .collection-folder:hover {
      border-color: var(--primary-300);
      background: var(--primary-50);
    }

    .folder-header {
      font-weight: 800;
      font-size: 11px;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      transition: var(--transition-fast);
    }

    .folder-header:hover {
      color: var(--primary-700);
    }

    .folder-content {
      margin-top: 10px;
      display: none;
    }

    .folder-content.active {
      display: block;
    }

    .folder-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 11px;
      transition: var(--transition-fast);
    }

    .folder-item:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      color: var(--primary-700);
    }

    /* Loader IA Premium */
    #ai-loader-inline {
      display: none;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-weight: 800;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 8px;
      padding: 8px 20px;
      background: rgba(79, 70, 229, 0.08);
      border-radius: 20px;
      letter-spacing: 0.05em;
    }

    .dot-pulse {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: pulse-glow 1.2s infinite ease-in-out;
    }

    @keyframes pulse-glow {
      0%, 100% {
        opacity: 0.4;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    /* Estilo Espec√≠fico Modal de Migra√ß√£o */
    .migration-option {
      background: var(--surface-100);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: var(--border-radius-md);
      margin-bottom: 12px;
    }

    .migration-option label {
      display: block;
      font-weight: 800;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .ops-btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    /* Form Corpo */
    .form-corpo {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid-compact {
        grid-template-columns: 1fr;
      }
      
      .header-enterprise {
        padding: 12px 16px;
      }
      
      .header-enterprise h2 {
        font-size: 14px;
      }
      
      .search-row {
        flex-direction: column;
      }
      
      .acoes {
        flex-wrap: wrap;
      }
      
      .btn-main {
        flex: 1;
        min-width: auto;
      }
      
      .btn-save {
        flex: 1 1 100%;
      }
      
      .painel-container {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="msgStatus" class="status"></div>
  
  <div id="dbModal" class="generic-modal" onclick="if(event.target==this) fecharModais()">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i data-lucide="cloud" style="width:18px;height:18px"></i> NUVEM ANIGEEK</h3>
        <button onclick="fecharModais()">√ó</button>
      </div>
      <div style="padding:14px; background:var(--surface-100); border-bottom:1px solid var(--border)">
        <input type="text" id="dbSearch" placeholder="Pesquisar..." oninput="filtrarDB()" style="width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:var(--border-radius-md); font-size:13px">
      </div>
      <div id="dbList" class="modal-body"></div>
    </div>
  </div>

  <div id="migrationModal" class="generic-modal" onclick="if(event.target==this) fecharModais()">
    <div class="modal-content" style="border: 2px solid var(--ops);">
      <div class="modal-header">
        <h3 style="color: var(--ops);"><i data-lucide="truck" style="width:18px;height:18px"></i> OPERA√á√ïES DE DADOS (PRO)</h3>
        <button onclick="fecharModais()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="background: rgba(239, 68, 68, 0.08); padding: 12px; border-radius: var(--border-radius-md); color: var(--danger); font-size: 11px; margin-bottom: 16px; border: 1px solid rgba(239, 68, 68, 0.2);">
          <i data-lucide="alert-triangle" style="width:16px;height:16px; vertical-align:middle"></i> <b>CUIDADO:</b> Voc√™ est√° prestes a modificar o banco de dados. Verifique os caminhos antes de confirmar.
        </div>
        <div class="migration-option">
          <label>DOCUMENTO ATUAL (ORIGEM)</label>
          <input type="text" id="migracaoOrigem" readonly style="background: var(--surface); font-weight: bold;">
        </div>
        <div class="migration-option">
          <label>COLE√á√ÉO DE DESTINO</label>
          <select id="migracaoDestinoColecao" style="font-weight: 800; padding:10px; border-radius:var(--border-radius-md); border:1px solid var(--border); width:100%"></select>
        </div>
        <div class="migration-option">
          <label>ID DO DOCUMENTO (DESTINO)</label>
          <input type="text" id="migracaoDestinoID" placeholder="Mantenha igual ou digite novo ID">
          <small style="color: var(--text-muted); font-size: 9px; display:block; margin-top:4px;">Deixe em branco para usar o mesmo ID da origem.</small>
        </div>
        <div class="ops-btn-group" id="migrationFooter">
          <button class="btn-main" style="background: var(--ops); color: white;" onclick="executarMigracao('copiar')">
            <i data-lucide="copy" style="width:16px;height:16px"></i> COPIAR / SOBRESCREVER
          </button>
          <button class="btn-main" style="background: var(--secondary); color: white;" onclick="executarMigracao('mover')">
            <i data-lucide="arrow-right-left" style="width:16px;height:16px"></i> MOVER (RECORTAR)
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="collectionModal" class="generic-modal" onclick="if(event.target==this) fecharModais()">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i data-lucide="folder-tree" style="width:18px;height:18px"></i> SELECIONAR COLE√á√ÉO</h3>
        <button onclick="fecharModais()">√ó</button>
      </div>
      <div class="modal-body" id="listaColecoesBtn"></div>
    </div>
  </div>

  <header class="header-enterprise">
    <h2><i data-lucide="cpu" style="width:18px;height:18px"></i> ANIGEEK AI STUDIO</h2>
    <span>V14.0 PRO DATA OPS EXECUTIVE</span>
  </header>

  <div class="painel-container">
    <div class="secao-card" style="border: 2px solid var(--warning);">
      <h3><i data-lucide="megaphone" style="width:16px;height:16px; color: var(--warning);"></i> Configura√ß√µes Globais de An√∫ncio</h3>
      <div class="campo-grupo">
        <label>Link de Redirecionamento PADR√ÉO (Propaganda do Player)</label>
        <input type="text" id="globalLinkPropaganda" placeholder="https://www.effectivegatecpm.com/...">
      </div>
      <div class="campo-grupo">
        <label>Script/HTML do Banner Topo PADR√ÉO</label>
        <textarea id="globalBannerTopo" style="min-height: 80px;" placeholder="Cole o script ou link do banner padr√£o aqui"></textarea>
      </div>
      <div class="campo-grupo">
        <label>Script/HTML do Banner Fundo PADR√ÉO</label>
        <textarea id="globalBannerFundo" style="min-height: 80px;" placeholder="Cole o script ou link do banner padr√£o aqui"></textarea>
      </div>
      <button class="btn-main btn-sec" style="width: 100%; background: var(--warning); color: #000;" onclick="salvarConfigAds()">
        <i data-lucide="save" style="width:16px;height:16px"></i> SALVAR CONFIGURA√á√ïES GLOBAIS
      </button>
    </div>

    <div class="smart-search-area">
      <div class="search-row">
        <input type="text" id="animeQuery" placeholder="1. Buscar Anime no MyAnimeList...">
        <button class="btn-search" onclick="buscarAnime()"><i data-lucide="sparkle" style="width:16px;height:16px"></i></button>
        
      </div>
      <div id="animeResults" class="results-dropdown"></div>
      <div id="episodeArea" style="display:none; margin-top: 16px; border-top: 1px solid var(--border); padding-top:16px;">
        <label style="font-size:9px; font-weight:800; color:var(--primary); display:block; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.05em;">2. REFINAR DOCUMENTO</label>
        <select id="episodeSelect" style="margin-bottom: 14px; width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--border-radius-md); background:var(--surface)"><option value="series_main">P√°gina Principal</option></select>
        <div class="ai-options" style="display:flex; gap:10px; margin-bottom:14px;">
          <div class="ai-chip" onclick="setAiMode('short', this)">Curto</div>
          <div class="ai-chip active" onclick="setAiMode('medium', this)">Narrativo</div>
          <div class="ai-chip" onclick="setAiMode('long', this)">Completo</div>
        </div>
        <button class="btn-search" style="background:var(--success); width: 100%;" onclick="carregarEpisodio()">
          <i data-lucide="zap" style="width:16px;height:16px"></i> EXTRAIR COM IA REAL (GEMINI)
        </button>
      </div>
    </div>

    <div class="grid-compact" style="margin-bottom: 14px;">
      <div class="campo-grupo">
        <label>Cole√ß√£o Ativa</label>
        <input type="text" id="colecaoDisplay" readonly value="Selecione..." onclick="abrirModalColecao()" style="cursor:pointer; font-weight:800; color:var(--primary);">
        <input type="hidden" id="colecaoAlvo">
      </div>
      <div class="campo-grupo">
        <label id="ordemLabel">Ordem de Exibi√ß√£o</label>
        <input type="number" id="ordemNoticia" value="1">
      </div>
    </div>

    <div class="form-corpo">
      <div class="secao-card" style="border-left: 5px solid var(--analytics);">
        <h3><i data-lucide="pie-chart" style="width:16px;height:16px; color: var(--analytics);"></i> Analytics & Monitoramento</h3>
        <div class="grid-compact">
          <div class="campo-grupo">
            <label>Visitantes √önicos</label>
            <input type="text" id="statsVisitantes" readonly value="0" style="background:var(--surface-100); font-weight:bold; color:var(--analytics);">
          </div>
          <div class="campo-grupo">
            <label>Cliques Player</label>
            <input type="text" id="statsPlayer" readonly value="0" style="background:var(--surface-100);">
          </div>
          <div class="campo-grupo">
            <label>Cliques Ads</label>
            <input type="text" id="statsAds" readonly value="0" style="background:var(--surface-100);">
          </div>
        </div>
        <div class="campo-grupo">
          <label>Log de Atividade Recente</label>
          <div id="logAtividades" style="max-height: 150px; overflow-y: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--border-radius-md); padding: 12px;">
            <div style="font-size:10px; color:var(--text-muted); text-align:center;">Selecione um documento para carregar os dados.</div>
          </div>
        </div>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="fingerprint" style="width:16px;height:16px"></i> Identidade Digital</h3>
        <div class="campo-grupo">
          <label>T√≠tulo Traduzido</label>
          <input type="text" id="titulo" oninput="gerarSlug(this.value)" placeholder="T√≠tulo do Card">
        </div>
        <div class="grid-compact">
          <div class="campo-grupo"><label>Slug/ID</label><input type="text" id="docId" readonly style="background:var(--surface-100)"></div>
          <div class="campo-grupo">
            <label>Hashtags</label>
            <input type="text" id="categoria" placeholder="A√ß√£o, Drama...">
          </div>
        </div>
        <div class="campo-grupo">
          <label>Cor Identidade</label>
          <input type="color" id="cor" value="#4f46e5" style="height:42px; padding:4px; border-radius:var(--border-radius-md);" oninput="atualizarCoresPainel()">
        </div>
      </div>

      <div class="secao-card" style="border-left: 5px solid var(--accent);">
        <h3><i data-lucide="rectangle-ad" style="width:16px;height:16px; color: var(--accent);"></i> An√∫ncios Exclusivos</h3>
        <div class="campo-grupo">
          <label>Link Propaganda Exclusivo</label>
          <input type="text" id="linkPropagandaArtigo" placeholder="Deixe em branco para usar o Global">
        </div>
        <div class="campo-grupo">
          <label>Script/HTML Banner Exclusivo</label>
          <textarea id="bannerAd" style="min-height: 80px;" placeholder="Script ou imagem que aparecer√° apenas neste artigo"></textarea>
        </div>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="photo-film" style="width:16px;height:16px"></i> Ativos de M√≠dia</h3>
        <div class="campo-grupo">
          <label>Thumbnail Card (16:9)</label>
          <input type="text" id="capaNoticia">
          <button class="btn-inspect" onclick="inspectMedia('capaNoticia')"><i data-lucide="eye" style="width:14px;height:14px"></i></button>
          <div id="viewer-capaNoticia" class="inspect-viewer"></div>
        </div>
        <div class="grid-compact">
          <div class="campo-grupo">
            <label>Banner HD Hero</label>
            <input type="text" id="capaUrl">
            <button class="btn-inspect" onclick="inspectMedia('capaUrl')"><i data-lucide="image" style="width:14px;height:14px"></i></button>
            <div id="viewer-capaUrl" class="inspect-viewer"></div>
          </div>
          <div class="campo-grupo"><label>Texto Banner</label><input type="text" id="capaDesc"></div>
        </div>
        <div class="campo-grupo">
          <label>ID YouTube ou Link Drive</label>
          <input type="text" id="videoPrincipal" placeholder="Ex: dQw4w9WgXcQ ou link do Drive">
          <button class="btn-inspect" onclick="inspectMedia('videoPrincipal')"><i data-lucide="play" style="width:14px;height:14px"></i></button>
          <div id="viewer-videoPrincipal" class="inspect-viewer"></div>
        </div>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="pen-tool" style="width:16px;height:16px"></i> Reda√ß√£o Inteligente</h3>
        <button class="toggle-btn" onclick="rephraseContent()"><i data-lucide="wand-sparkles" style="width:12px;height:12px"></i> IA REESCREVER</button>
        <div class="campo-grupo">
          <label>Conte√∫do da Not√≠cia/Review</label>
          <textarea id="resumo" style="min-height: 220px;" oninput="contarCaracteres()"></textarea>
          <div class="char-counter" id="charCounter">1000 caracteres restantes</div>
        </div>
        <div class="campo-grupo">
          <label>Fonte de Refer√™ncia (Link)</label>
          <input type="text" id="linkArtigo" placeholder="https://...">
        </div>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="list-check" style="width:16px;height:16px"></i> Ficha T√©cnica</h3>
        <div id="container-ficha"></div>
        <button class="btn-add" onclick="adicionarFicha()">+ Adicionar Atributo</button>
      </div>

      <div class="grid-compact">
        <div class="secao-card">
          <h3><i data-lucide="user-cog" style="width:16px;height:16px"></i> Editor</h3>
          <div class="campo-grupo"><label>Avatar</label><input type="text" id="perfilImg"></div>
          <div id="container-ficha-editor"></div>
          <button class="btn-add" onclick="adicionarFichaEditor()">+ Cargo</button>
        </div>
        <div class="secao-card">
          <h3><i data-lucide="trending-up" style="width:16px;height:16px"></i> M√©tricas</h3>
          <div class="campo-grupo"><label>Likes</label><input type="number" id="curtidas" value="0"></div>
          <div class="campo-grupo"><label>Views</label><input type="number" id="visualizacoes" value="0"></div>
        </div>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="youtube" style="width:16px;height:16px"></i> V√≠deos Vinculados</h3>
        <div id="container-relacionados"></div>
        <button class="btn-add" onclick="adicionarRelacionado()">+ Vincular V√≠deo</button>
      </div>

      <div class="secao-card">
        <h3><i data-lucide="shopping-cart" style="width:16px;height:16px"></i> Vitrine de Produtos</h3>
        <div id="container-produtos"></div>
        <button class="btn-add" onclick="adicionarProduto()">+ Adicionar Produto</button>
      </div>
    </div>
  </div>

  <div class="acoes-wrapper">
    <div id="ai-loader-inline"><div class="dot-pulse"></div><div class="dot-pulse"></div><div class="dot-pulse"></div><span id="loader-text-inline">IA PROCESSANDO...</span></div>
    <div class="acoes">
      <button class="btn-main btn-delete" onclick="deletarDocumento()"><i data-lucide="trash-2" style="width:16px;height:16px"></i></button>
      <button class="btn-main btn-ops" onclick="prepararMigracao()"><i data-lucide="truck" style="width:16px;height:16px"></i> MIGRAR</button>
      <button class="btn-main btn-sec" onclick="toggleCloud()"><i data-lucide="database" style="width:16px;height:16px"></i> BANCO</button>
      <button class="btn-main btn-save" onclick="salvarGeral()"><i data-lucide="cloud-upload" style="width:16px;height:16px"></i> PUBLICAR</button>
      <button class="btn-search" onclick="buscarAnime()"><i data-lucide="sparkle" style="width:16px;height:16px"></i></button>
<button class="btn-main" style="background: var(--ops); color: white; min-width: 40px;" onclick="prepararMigracaoMassa()" title="Migra√ß√£o em Massa">
  <i data-lucide="layers" style="width:16px;height:16px"></i>
</button>
</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // CONFIGURA√á√ÉO DOS CAMINHOS DO USU√ÅRIO
    const COLLECTIONS_MAP = [
      // --- WACHE ---
      { id: "wache.web.app/animes_filmes_series_games_noticias/Jujutsu_kaisen_shimetsu_kaiyu", label: "[Wache] Jujutsu Kaisen", folder: "Wache" },
      { id: "wache.web.app/animes_filmes_series_games_noticias/chainsaw_man", label: "[Wache] Chainsaw Man", folder: "Wache" },
      { id: "wache.web.app/animes_filmes_series_games_noticias/saihate_no_paladin", label: "[Wache] Saihate no Paladin", folder: "Wache" },
      { id: "wache.web.app/animes_filmes_series_games_noticias/sentenced_to_be_a_hero", label: "[Wache] Sentenced to be a Hero", folder: "Wache" },
      
      // --- MELIODAS ---
      { id: "meliodas.web.app/animes_filmes_series_games_noticias/Jujutsu_kaisen_shimetsu_kaiyu", label: "[Meliodas] Jujutsu Kaisen", folder: "Meliodas" },
      { id: "meliodas.web.app/animes_filmes_series_games_noticias/chainsaw_man", label: "[Meliodas] Chainsaw Man", folder: "Meliodas" },
      { id: "meliodas.web.app/animes_filmes_series_games_noticias/saihate_no_paladin", label: "[Meliodas] Saihate no Paladin", folder: "Meliodas" },
      { id: "meliodas.web.app/animes_filmes_series_games_noticias/sentenced_to_be_a_hero", label: "[Meliodas] Sentenced to be a Hero", folder: "Meliodas" },
      
      // --- DANIEL ---
      { id: "daniel.web.app/animes_filmes_series_games_noticias/Jujutsu_kaisen_shimetsu_kaiyu", label: "[Daniel] Jujutsu Kaisen", folder: "Daniel" },
      { id: "daniel.web.app/animes_filmes_series_games_noticias/chainsaw_man", label: "[Daniel] Chainsaw Man", folder: "Daniel" },
      { id: "daniel.web.app/animes_filmes_series_games_noticias/saihate_no_paladin", label: "[Daniel] Saihate no Paladin", folder: "Daniel" },
      { id: "daniel.web.app/animes_filmes_series_games_noticias/sentenced_to_be_a_hero", label: "[Daniel] Sentenced to be a Hero", folder: "Daniel" },
      
      // --- ANIGEEK NEWS ---
      { id: "anigeeknews.web.app/animes_filmes_series_games_noticias/Jujutsu_kaisen_shimetsu_kaiyu", label: "[AniGeek] Jujutsu Kaisen", folder: "AniGeek" },
      { id: "anigeeknews.web.app/animes_filmes_series_games_noticias/chainsaw_man", label: "[AniGeek] Chainsaw Man", folder: "AniGeek" },
      { id: "anigeeknews.web.app/animes_filmes_series_games_noticias/saihate_no_paladin", label: "[AniGeek] Saihate no Paladin", folder: "AniGeek" },
      { id: "anigeeknews.web.app/animes_filmes_series_games_noticias/sentenced_to_be_a_hero", label: "[AniGeek] Sentenced to be a Hero", folder: "AniGeek" },
      { id: "anigeeknews.web.app/animes_filmes_series_games_noticias/anime_i_geek", label: "[AniGeek] Anime i Geek", folder: "AniGeek" },
      
      // --- RAIZ / OUTROS ---
      { id: "chainsaw_man", label: "Chainsaw Man (Raiz)", folder: "Raiz" },
      { id: "Jujutsu_kaisen_shimetsu_kaiyu", label: "Jujutsu Kaisen (Raiz)", folder: "Raiz" },
      { id: "saihate_no_paladin", label: "Saihate no Paladin (Raiz)", folder: "Raiz" },
      { id: "Animes_adm_luiz/animes/daniel.web.app/animes_filmes_series_games_noticias/", label: "Animes ADM Luiz (Complexo)", folder: "Raiz" }
    ];
    
    let currentAnimeData = null;
    let aiMode = 'medium';
    let debounceTimer;
    let hasUnsavedChanges = false;
    
    // ============================================
    // NOVAS FUNCIONALIDADES
    // ============================================
    
    // 1. Salvamento autom√°tico com debounce e localStorage
    function setupAutoSave() {
      const formFields = ['titulo', 'categoria', 'resumo', 'cor', 'linkArtigo', 'videoPrincipal', 'capaNoticia', 'capaUrl', 'capaDesc', 'bannerAd', 'linkPropagandaArtigo', 'curtidas', 'visualizacoes', 'perfilImg'];
      formFields.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          hasUnsavedChanges = true;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(salvarDraftLocal, 1000);
        });
      });
    }
    
    function salvarDraftLocal() {
      const draftKey = `draft_${document.getElementById('colecaoAlvo').value}_${document.getElementById('docId').value}`;
      const dados = coletarDadosFormulario();
      localStorage.setItem(draftKey, JSON.stringify(dados));
      mostrarStatus("Draft salvo localmente!", "var(--success)");
    }
    
    function carregarDraftLocal() {
      const col = document.getElementById('colecaoAlvo').value;
      const docId = document.getElementById('docId').value;
      if (!col || !docId) return;
      const draftKey = `draft_${col}_${docId}`;
      const draft = localStorage.getItem(draftKey);
      if (draft) {
        const dados = JSON.parse(draft);
        document.getElementById('titulo').value = dados.titulo || '';
        document.getElementById('categoria').value = dados.categoria || '';
        document.getElementById('resumo').value = dados.resumo || '';
        document.getElementById('cor').value = dados.cor || '#4f46e5';
        document.getElementById('linkArtigo').value = dados.linkArtigo || '';
        document.getElementById('videoPrincipal').value = dados.videoPrincipal || '';
        document.getElementById('capaNoticia').value = dados.capaNoticia || '';
        document.getElementById('capaUrl').value = dados.capaUrl || '';
        document.getElementById('capaDesc').value = dados.capaDesc || '';
        document.getElementById('bannerAd').value = dados.bannerAd || '';
        document.getElementById('linkPropagandaArtigo').value = dados.linkPropagandaArtigo || '';
        document.getElementById('curtidas').value = dados.curtidas || 0;
        document.getElementById('visualizacoes').value = dados.visualizacoes || 0;
        document.getElementById('perfilImg').value = dados.perfilImg || '';
        
        // Recarrega arrays
        document.getElementById('container-ficha').innerHTML = '';
        dados.ficha?.forEach(f => adicionarFicha(f.label, f.valor));
        document.getElementById('container-ficha-editor').innerHTML = '';
        dados.fichaCategoria?.info?.forEach(i => adicionarFichaEditor(i.label, i.valor));
        document.getElementById('container-relacionados').innerHTML = '';
        dados.relacionados?.forEach(r => adicionarRelacionado(r.idVid, r.titulo, r.thumb));
        document.getElementById('container-produtos').innerHTML = '';
        dados.produtos?.forEach(p => adicionarProduto(p.nome, p.link, p.img, p.desc));
        
        atualizarCoresPainel();
        contarCaracteres();
      }
    }
    
    // 2. Valida√ß√£o de formul√°rio pr√©-Firebase
    function validarFormulario() {
      const titulo = document.getElementById('titulo').value.trim();
      const capaNoticia = document.getElementById('capaNoticia').value.trim();
      const docId = document.getElementById('docId').value.trim();
      if (!titulo || !capaNoticia || !docId) {
        alert("Preencha os campos essenciais: T√≠tulo, Imagem e Slug!");
        return false;
      }
      return true;
    }
    
    // 3. Pr√©-visualiza√ß√£o din√¢mica de cores
    function atualizarCoresPainel() {
      const cor = document.getElementById('cor').value;
      document.documentElement.style.setProperty('--primary', cor);
      document.documentElement.style.setProperty('--primary-dark', ajustarCorEscura(cor));
    }
    
    function ajustarCorEscura(hex) {
      let r = parseInt(hex.slice(1, 3), 16);
      let g = parseInt(hex.slice(3, 5), 16);
      let b = parseInt(hex.slice(5, 7), 16);
      r = Math.max(0, r - 50);
      g = Math.max(0, g - 50);
      b = Math.max(0, b - 50);
      return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }
    
    // 4. Contador de caracteres
    function contarCaracteres() {
      const resumo = document.getElementById('resumo').value;
      const max = 1000;
      const restantes = max - resumo.length;
      const counter = document.getElementById('charCounter');
      counter.textContent = `${restantes} caracteres restantes`;
      counter.className = restantes < 100 ? 'char-counter warning' : 'char-counter';
    }
    
    // 5. Feedback visual de progresso detalhado
    function setLoader(show, text = "") {
      const loader = document.getElementById('ai-loader-inline');
      const txt = document.getElementById('loader-text-inline');
      loader.style.display = show ? 'flex' : 'none';
      if (text) txt.innerText = text;
    }
    
    // 6. Confirma√ß√£o de sa√≠da
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Tem certeza que deseja sair?';
      }
    });
    
    // 7. Organiza√ß√£o de cole√ß√µes em pastas
    function renderCollectionsList() {
      const container = document.getElementById('listaColecoesBtn');
      container.innerHTML = '';
      
      // Agrupa por pasta
      const folders = {};
      COLLECTIONS_MAP.forEach(c => {
        if (!folders[c.folder]) folders[c.folder] = [];
        folders[c.folder].push(c);
      });
      
      // Renderiza cada pasta
      for (const [folderName, items] of Object.entries(folders)) {
        const folderDiv = document.createElement('div');
        folderDiv.className = 'collection-folder';
        
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.innerHTML = `<i data-lucide="folder" style="width:16px;height:16px"></i> ${folderName} üìÅ`;
        header.onclick = () => {
          const content = header.nextElementSibling;
          content.classList.toggle('active');
          lucide.createIcons();
        };
        
        const content = document.createElement('div');
        content.className = 'folder-content';
        
        items.forEach(c => {
          const btn = document.createElement('div');
          btn.className = 'folder-item';
          btn.innerHTML = `<i data-lucide="file" style="width:14px;height:14px"></i> ${c.label}`;
          btn.onclick = (e) => {
            e.stopPropagation();
            selecionarColecao(c.id, c.label);
          };
          content.appendChild(btn);
        });
        
        folderDiv.appendChild(header);
        folderDiv.appendChild(content);
        container.appendChild(folderDiv);
      }
      
      lucide.createIcons();
    }
    
    // ============================================
    // GEST√ÉO DE COLE√á√ïES
    // ============================================
    renderCollectionsList();
    
    // ============================================
    // L√ìGICA DE MIGRA√á√ÉO (PRO)
    // ============================================
    window.prepararMigracao = () => {
      const docId = document.getElementById('docId').value;
      const colOrigem = document.getElementById('colecaoAlvo').value;
      if(!docId) return alert("Selecione ou crie um documento primeiro.");
      
      // Restaura o footer original caso tenha sido alterado pela migra√ß√£o em massa
      const footer = document.getElementById('migrationFooter');
      footer.innerHTML = `
        <button class="btn-main" style="background: var(--ops); color: white;" onclick="executarMigracao('copiar')">
          <i data-lucide="copy" style="width:16px;height:16px"></i> COPIAR / SOBRESCREVER
        </button>
        <button class="btn-main" style="background: var(--secondary); color: white;" onclick="executarMigracao('mover')">
          <i data-lucide="arrow-right-left" style="width:16px;height:16px"></i> MOVER (RECORTAR)
        </button>
      `;
      
      document.getElementById('migracaoOrigem').value = `${colOrigem} / ${docId}`;
      document.getElementById('migracaoDestinoID').value = docId;
      const sel = document.getElementById('migracaoDestinoColecao');
      sel.innerHTML = '';
      COLLECTIONS_MAP.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.label;
        if(c.id === colOrigem) opt.selected = true;
        sel.appendChild(opt);
      });
      
      document.getElementById('migrationModal').style.display = 'flex';
      lucide.createIcons();
    };

    window.prepararMigracaoMassa = () => {
        // Abre o modal de migra√ß√£o mas foca na a√ß√£o em massa
        const sel = document.getElementById('migracaoDestinoColecao');
        sel.innerHTML = ''; // Limpa antes de carregar
        COLLECTIONS_MAP.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.label;
            sel.appendChild(opt);
        });
        
        // Muda o comportamento dos bot√µes do modal de migra√ß√£o para o modo "Massa"
        const footer = document.getElementById('migrationFooter');
        footer.innerHTML = `
            <button class="btn-main" style="background: var(--success); color: white; grid-column: span 2;" onclick="executarMigracaoEmMassa()">
                <i data-lucide="check-circle"></i> CONFIRMAR MIGRA√á√ÉO EM MASSA
            </button>
        `;
        
        document.getElementById('migrationModal').style.display = 'flex';
        lucide.createIcons();
    };

    window.executarMigracaoEmMassa = async () => {
    const colDestino = document.getElementById('migracaoDestinoColecao').value;
    const colOrigem = document.getElementById('colecaoAlvo').value;

    if (!colOrigem || colOrigem === colDestino) {
        return alert("Selecione cole√ß√µes de origem e destino diferentes.");
    }

    if (!confirm(`Deseja COPIAR TODOS os documentos de:\n${colOrigem}\nPara:\n${colDestino}?`)) return;

    setLoader(true, "INICIANDO MIGRA√á√ÉO...");
    
    try {
        const { writeBatch, collection, getDocs, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const snap = await getDocs(collection(db, colOrigem));
        if (snap.empty) {
            alert("A cole√ß√£o de origem est√° vazia.");
            setLoader(false);
            return;
        }

        let batch = writeBatch(db);
        let count = 0;
        let totalCopiado = 0;
        const total = snap.size;

        for (const docSnap of snap.docs) {
            const docRef = doc(db, colDestino, docSnap.id);
            batch.set(docRef, docSnap.data());
            
            count++;
            totalCopiado++;

            // O Firebase permite no m√°ximo 500 opera√ß√µes por lote (Batch)
            if (count === 500) {
                setLoader(true, `ENVIANDO LOTE (${totalCopiado}/${total})...`);
                await batch.commit();
                batch = writeBatch(db);
                count = 0;
            }
            
            if (totalCopiado % 10 === 0) { // Feedback visual a cada 10 docs
                setLoader(true, `PREPARANDO: ${totalCopiado}/${total}`);
            }
        }

        // Envia o √∫ltimo lote se houver algo restante
        if (count > 0) {
            await batch.commit();
        }

        mostrarStatus(`SUCESSO: ${totalCopiado} DOCUMENTOS COPIADOS!`, "var(--success)");
        fecharModais();
    } catch (e) {
        console.error("Erro na migra√ß√£o:", e);
        alert("Erro cr√≠tico: " + e.message);
    } finally {
        setLoader(false);
    }
};

    
    window.executarMigracao = async (acao) => {
      const docIdOrigem = document.getElementById('docId').value;
      const colOrigem = document.getElementById('colecaoAlvo').value;
      const colDestino = document.getElementById('migracaoDestinoColecao').value;
      let docIdDestino = document.getElementById('migracaoDestinoID').value.trim();
      if(!docIdDestino) docIdDestino = docIdOrigem;
      if(!confirm(`Confirmar a√ß√£o: ${acao.toUpperCase()}?
De: ${colOrigem}
Para: ${colDestino}`)) return;
      
      setLoader(true, `EXECUTANDO: ${acao.toUpperCase()}...`);
      
      try {
        const dados = coletarDadosFormulario();
        await setDoc(doc(db, colDestino, docIdDestino), dados);
        
        if (acao === 'mover') {
          if(colOrigem !== colDestino || docIdOrigem !== docIdDestino) {
            await deleteDoc(doc(db, colOrigem, docIdOrigem));
            mostrarStatus("MOVIDO COM SUCESSO!", "var(--success)");
            selecionarColecao(colDestino, COLLECTIONS_MAP.find(c=>c.id===colDestino)?.label || colDestino);
            document.getElementById('docId').value = docIdDestino;
            document.getElementById('ordemLabel').innerHTML = `Ordem (DOC: ${docIdDestino})`;
          } else {
            mostrarStatus("DADOS ATUALIZADOS (MESMO LOCAL)", "var(--success)");
          }
        } else {
          mostrarStatus("COPIADO COM SUCESSO!", "var(--success)");
        }
        
        fecharModais();
      } catch (error) {
        console.error(error);
        alert("Erro na opera√ß√£o: " + error.message);
      } finally {
        setLoader(false);
      }
    };
    
    // ============================================
    // FUN√á√ïES PADR√ÉO (MANTIDAS)
    // ============================================
    window.salvarConfigAds = async () => {
      setLoader(true, "SALVANDO AN√öNCIOS...");
      const dadosAds = {
        linkPropaganda: document.getElementById('globalLinkPropaganda').value,
        bannerTopo: document.getElementById('globalBannerTopo').value,
        bannerFundo: document.getElementById('globalBannerFundo').value
      };
      try {
        await setDoc(doc(db, "configuracoes", "ads"), dadosAds);
        setLoader(false);
        mostrarStatus("ADS GLOBAIS ATUALIZADOS!", "var(--warning)");
      } catch(e) {
        setLoader(false);
        alert("Erro ao salvar Ads");
      }
    };
    
    async function carregarConfigAds() {
      const snap = await getDoc(doc(db, "configuracoes", "ads"));
      if(snap.exists()){
        const d = snap.data();
        document.getElementById('globalLinkPropaganda').value = d.linkPropaganda || '';
        document.getElementById('globalBannerTopo').value = d.bannerTopo || '';
        document.getElementById('globalBannerFundo').value = d.bannerFundo || '';
      }
    }
    
    async function callGeminiAI(prompt) {
      return await smartTranslate(prompt, "en|pt-BR");
    }
    
    async function smartTranslate(text, pair = "en|pt-BR") {
      if (!text) return "";
      const chunks = text.match(/.{1,450}/g) || [text];
      let results = [];
      for (const chunk of chunks) {
        try {
          const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunk)}&langpair=${pair}`);
          const data = await res.json();
          results.push(data.responseData.translatedText || chunk);
        } catch (e) {
          results.push(chunk);
        }
      }
      return results.join("");
    }
    
    window.setAiMode = (mode, el) => {
      aiMode = mode;
      document.querySelectorAll('.ai-chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
    };
    
    window.fecharModais = () => document.querySelectorAll('.generic-modal').forEach(m => m.style.display = 'none');
    
    window.abrirModalColecao = () => document.getElementById('collectionModal').style.display = 'flex';
    
    window.toggleCloud = async () => {
      document.getElementById('dbModal').style.display = 'flex';
      await carregarListaCloud();
    };
    
    window.selecionarColecao = (id, nome) => {
      document.getElementById('colecaoAlvo').value = id;
      document.getElementById('colecaoDisplay').value = nome;
      fecharModais();
      carregarListaCloud();
      carregarDraftLocal();
    };
    
    window.rephraseContent = async () => {
      const txt = document.getElementById('resumo').value;
      if(!txt) return;
      setLoader(true, "GEMINI REELABORANDO TEXTO...");
      const en = await smartTranslate(txt, "pt-BR|en");
      const pt = await smartTranslate(en, "en|pt-BR");
      document.getElementById('resumo').value = pt;
      setLoader(false);
      mostrarStatus("TEXTO REESCRITO COM IA", "var(--success)");
    };
    
    window.buscarAnime = () => {
      const q = document.getElementById('animeQuery').value;
      const resBox = document.getElementById('animeResults');
      if(q.length < 3) return;
      resBox.style.display = 'block';
      resBox.innerHTML = '<div class="result-item">Buscando na MAL...</div>';
      fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(q)}&limit=5`)
        .then(r => r.json()).then(d => {
          resBox.innerHTML = '';
          d.data.forEach(a => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `<strong>${a.title}</strong><br><small>${a.type} ‚Ä¢ ${a.year || ''}</small>`;
            div.onclick = () => selecionarSerie(a);
            resBox.appendChild(div);
          });
        });
    };
    
    async function selecionarSerie(anime) {
      currentAnimeData = anime;
      document.getElementById('animeResults').style.display = 'none';
      document.getElementById('animeQuery').value = anime.title;
      document.getElementById('episodeArea').style.display = 'block';
      const sel = document.getElementById('episodeSelect');
      sel.innerHTML = '<option value="series_main">P√°gina Principal</option>';
      try {
        const r = await fetch(`https://api.jikan.moe/v4/anime/${anime.mal_id}/episodes`);
        const data = await r.json();
        data.data.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.mal_id;
          opt.innerText = `Epis√≥dio ${e.mal_id}: ${e.title}`;
          opt.dataset.title = e.title;
          sel.appendChild(opt);
        });
      } catch(err) {}
    }
    
    window.carregarEpisodio = async () => {
      if(!currentAnimeData) return;
      setLoader(true, "IA EXTRAINDO DADOS...");
      const select = document.getElementById('episodeSelect');
      let titleRaw = currentAnimeData.title;
      if (select.value !== 'series_main') titleRaw = `EP ${select.value} - ${select.selectedOptions[0].dataset.title}`;
      
      const [tit, sin] = await Promise.all([
        callGeminiAI(titleRaw),
        callGeminiAI(currentAnimeData.synopsis)
      ]);
      
      document.getElementById('titulo').value = tit;
      gerarSlug(tit);
      document.getElementById('resumo').value = sin;
      document.getElementById('categoria').value = currentAnimeData.genres.map(g=>g.name).join(', ');
      document.getElementById('capaNoticia').value = currentAnimeData.images.jpg.large_image_url;
      document.getElementById('capaUrl').value = currentAnimeData.images.jpg.large_image_url;
      document.getElementById('capaDesc').value = currentAnimeData.title;
      
      const f = document.getElementById('container-ficha');
      f.innerHTML = '';
      adicionarFicha("T√≠tulo Original", currentAnimeData.title_japanese || "N/A");
      adicionarFicha("Est√∫dio", currentAnimeData.studios[0]?.name || "N/A");
      adicionarFicha("Temporada", currentAnimeData.season ? `${currentAnimeData.season} ${currentAnimeData.year}` : "N/A");
      adicionarFicha("Fonte", currentAnimeData.source || "N/A");
      adicionarFicha("Score MAL", currentAnimeData.score || "N/A");
      adicionarFicha("Popularidade", `#${currentAnimeData.popularity}`);
      adicionarFicha("Membros", currentAnimeData.members.toLocaleString());
      adicionarFicha("Licen√ßa", currentAnimeData.licensors[0]?.name || "N/A");
      
      setLoader(false);
      mostrarStatus("DADOS SINCRONIZADOS", "var(--success)");
    };
    
    window.adicionarFicha = (l='', v='') => {
      const d = document.createElement('div');
      d.className = 'item-flex';
      d.innerHTML = `<input type="text" class="f-label" value="${l}" placeholder="Label"><input type="text" class="f-valor" value="${v}" placeholder="Valor"><button class="btn-remover" onclick="this.parentElement.remove()">√ó</button>`;
      document.getElementById('container-ficha').appendChild(d);
    };
    
    window.adicionarFichaEditor = (l='', v='') => {
      const d = document.createElement('div');
      d.className = 'item-flex';
      d.innerHTML = `<input type="text" class="fe-label" value="${l}" placeholder="Cargo"><input type="text" class="fe-valor" value="${v}" placeholder="Nome"><button class="btn-remover" onclick="this.parentElement.remove()">√ó</button>`;
      document.getElementById('container-ficha-editor').appendChild(d);
    };
    
    window.adicionarRelacionado = (id='', t='', th='') => {
      const d = document.createElement('div');
      d.style.cssText = "background:var(--surface-100); padding:12px; border-radius:var(--border-radius-md); border:1px solid var(--border); margin-bottom:12px;";
      d.innerHTML = `<div class="item-flex"><input type="text" class="r-id" value="${id}" placeholder="ID YouTube"><button class="btn-remover" onclick="this.parentElement.remove()">√ó</button></div><input type="text" class="r-titulo" value="${t}" placeholder="T√≠tulo V√≠deo" style="margin-bottom:6px"><input type="text" class="r-thumb" value="${th}" placeholder="Thumb (Opcional)">`;
      document.getElementById('container-relacionados').appendChild(d);
    };
    
    window.adicionarProduto = (n='', l='', i='', ds='') => {
      const d = document.createElement('div');
      d.style.cssText = "background:var(--surface-100); padding:12px; border-radius:var(--border-radius-md); border:1px solid var(--border); margin-bottom:12px;";
      d.innerHTML = `<div class="item-flex"><input type="text" class="p-nome" value="${n}" placeholder="Nome"><button class="btn-remover" onclick="this.parentElement.remove()">√ó</button></div><input type="text" class="p-link" value="${l}" placeholder="Link Loja" style="margin-bottom:6px"><input type="text" class="p-img" value="${i}" placeholder="URL Imagem" style="margin-bottom:6px"><textarea class="p-desc" placeholder="Descri√ß√£o">${ds}</textarea>`;
      document.getElementById('container-produtos').appendChild(d);
    };
    
    window.salvarGeral = async () => {
      if (!validarFormulario()) return;
      const id = document.getElementById('docId').value;
      const col = document.getElementById('colecaoAlvo').value;
      if(!id) return alert("Slug necess√°rio");
      
      setLoader(true, "VALIDANDO DADOS...");
      await new Promise(resolve => setTimeout(resolve, 500));
      setLoader(true, "PROCESSANDO IA...");
      await new Promise(resolve => setTimeout(resolve, 800));
      setLoader(true, "ENVIANDO PARA O FIREBASE...");
      
      const dados = coletarDadosFormulario();
      try {
        await setDoc(doc(db, col, id), dados, { merge: true });
        hasUnsavedChanges = false;
        localStorage.removeItem(`draft_${col}_${id}`);
        setLoader(false);
        mostrarStatus("SALVO NA NUVEM!", "var(--success)");
        carregarListaCloud();
      } catch (e) {
        setLoader(false);
        alert("Erro ao salvar");
      }
    };
    
    window.carregarAnalytics = async (col, docId) => {
      const statsVisitantes = document.getElementById('statsVisitantes');
      const statsPlayer = document.getElementById('statsPlayer');
      const statsAds = document.getElementById('statsAds');
      const logArea = document.getElementById('logAtividades');
      
      statsVisitantes.value = "...";
      statsPlayer.value = "...";
      statsAds.value = "...";
      logArea.innerHTML = '<div style="font-size:10px; color:var(--text-muted); text-align:center;">Carregando dados de visitantes...</div>';
      
      try {
        const visitantesRef = collection(db, col, docId, "visitantes");
        const snapshot = await getDocs(visitantesRef);
        let totalV = snapshot.size;
        let totalPlayer = 0;
        let totalAds = 0;
        let logHTML = "";
        
        if (snapshot.empty) {
          logArea.innerHTML = '<div style="font-size:10px; color:var(--text-muted); text-align:center;">Nenhum visitante registrado ainda.</div>';
          statsVisitantes.value = 0;
          statsPlayer.value = 0;
          statsAds.value = 0;
          return;
        }
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const visitorId = docSnap.id;
          let actionsCount = 0;
          
          if (data.actions && Array.isArray(data.actions)) {
            actionsCount = data.actions.length;
            data.actions.forEach(act => {
              if(act.type === 'player_click' || act.type === 'player') totalPlayer++;
              if(act.type === 'ad_click' || act.type === 'ad') totalAds++;
            });
          }
          
          logHTML += `
            <div style="font-size:10px; border-bottom:1px solid var(--neutral-200); padding:8px 0; display:flex; justify-content:space-between;">
              <span><i data-lucide="user" style="width:12px;height:12px; vertical-align:middle"></i> ...${visitorId.slice(-8)}</span>
              <span><b>${actionsCount}</b> A√ß√µes</span>
            </div>
          `;
        });
        
        statsVisitantes.value = totalV;
        statsPlayer.value = totalPlayer;
        statsAds.value = totalAds;
        logArea.innerHTML = logHTML;
        
        lucide.createIcons(logArea);
      } catch (e) {
        console.error(e);
        logArea.innerHTML = '<div style="font-size:10px; color:var(--danger); text-align:center;">Erro ao carregar Analytics.</div>';
      }
    };
    
    window.carregarPorID = async (id) => {
      setLoader(true);
      const col = document.getElementById('colecaoAlvo').value;
      const snap = await getDoc(doc(db, col, id));
      if(snap.exists()){
        const d = snap.data();
        document.getElementById('docId').value = id;
        document.getElementById('ordemNoticia').value = d.ordem || 0;
        document.getElementById('titulo').value = d.titulo || '';
        document.getElementById('resumo').value = d.resumo || '';
        document.getElementById('categoria').value = d.categoria || '';
        document.getElementById('capaNoticia').value = d.capaNoticia || '';
        document.getElementById('capaUrl').value = d.capaUrl || '';
        document.getElementById('capaDesc').value = d.capaDesc || '';
        document.getElementById('bannerAd').value = d.bannerAd || '';
        document.getElementById('linkPropagandaArtigo').value = d.linkPropagandaArtigo || '';
        document.getElementById('curtidas').value = d.curtidas || 0;
        document.getElementById('visualizacoes').value = d.visualizacoes || 0;
        document.getElementById('linkArtigo').value = d.linkArtigo || '';
        document.getElementById('videoPrincipal').value = d.videoPrincipal || '';
        document.getElementById('perfilImg').value = d.fichaCategoria?.perfilImg || '';
        document.getElementById('cor').value = d.cor || '#4f46e5';
        
        document.getElementById('container-ficha').innerHTML = '';
        d.ficha?.forEach(f => adicionarFicha(f.label, f.valor));
        
        document.getElementById('container-ficha-editor').innerHTML = '';
        d.fichaCategoria?.info?.forEach(i => adicionarFichaEditor(i.label, i.valor));
        
        document.getElementById('container-relacionados').innerHTML = '';
        d.relacionados?.forEach(r => adicionarRelacionado(r.idVid, r.titulo, r.thumb));
        
        document.getElementById('container-produtos').innerHTML = '';
        d.produtos?.forEach(p => adicionarProduto(p.nome, p.link, p.img, p.desc));
        
        await carregarAnalytics(col, id);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        atualizarCoresPainel();
        contarCaracteres();
        hasUnsavedChanges = false;
      }
      setLoader(false);
    };
    
    async function carregarListaCloud() {
      const col = document.getElementById('colecaoAlvo').value;
      if(!col) return;
      const q = query(collection(db, col), orderBy("ordem", "asc"));
      try {
        const snap = await getDocs(q);
        const listEl = document.getElementById('dbList');
        listEl.innerHTML = '';
        if (snap.empty) {
          listEl.innerHTML = '<div style="padding:14px; text-align:center; color:var(--text-muted);">Nenhum documento encontrado nesta cole√ß√£o.</div>';
          return;
        }
        snap.forEach(d => {
          const data = d.data();
          const btn = document.createElement('button');
          btn.className = 'btn-main btn-sec';
          btn.style.width = '100%';
          btn.style.marginBottom = '8px';
          btn.style.justifyContent = 'space-between';
          btn.innerHTML = `<span style="flex:1; text-align:left; font-size:13px">#${data.ordem} - ${data.titulo}</span> <i data-lucide="chevron-right" style="width:16px;height:16px"></i>`;
          btn.onclick = () => { carregarPorID(d.id); fecharModais(); };
          listEl.appendChild(btn);
        });
        lucide.createIcons(listEl);
      } catch(e) {
        console.log("Erro ao carregar lista (pode ser a primeira vez): ", e);
        document.getElementById('dbList').innerHTML = '<div style="padding:14px; text-align:center; color:var(--text-muted);">Cole√ß√£o vazia ou n√£o inicializada.</div>';
      }
    }
    
    window.inspectMedia = (fieldId) => {
      let val = document.getElementById(fieldId).value.trim();
      const viewer = document.getElementById('viewer-' + fieldId);
      if(!val) return;
      if(viewer.style.display === 'block') {
        viewer.style.display = 'none';
        return;
      }
      if (val.includes('drive.google.com')) {
        let driveUrl = val;
        if (val.includes('/file/d/')) {
          const id = val.split('/file/d/')[1].split('/')[0];
          driveUrl = `https://drive.google.com/file/d/${id}/preview`;
        } else if (val.includes('id=')) {
          const id = val.split('id=')[1].split('&')[0];
          driveUrl = `https://drive.google.com/file/d/${id}/preview`;
        }
        viewer.innerHTML = `<iframe src="${driveUrl}" allowfullscreen style="border:none"></iframe>`;
      } else if (val.length === 11 || val.includes('youtube') || val.includes('http://googleusercontent.com/youtube.com/')) {
        let id = val;
        if (val.includes('v=')) id = val.split('v=')[1].split('&')[0];
        else if (val.includes('youtu.be/')) id = val.split('youtu.be/')[1].split('?')[0];
        viewer.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen style="border:none"></iframe>`;
      } else {
        viewer.innerHTML = `<img src="${val}" onerror="this.src='https://placehold.co/600x400?text=Midia+Invalida'" style="object-fit:cover">`;
      }
      viewer.style.display = 'block';
    };
    
    window.gerarSlug = (v) => {
      const s = v.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^\w ]+/g, '').replace(/ +/g, '-');
      document.getElementById('docId').value = s;
      document.getElementById('ordemLabel').innerHTML = `Ordem (DOC: ${s})`;
    };
    
    function mostrarStatus(txt, cor) {
      const s = document.getElementById('msgStatus');
      s.style.display = "block";
      s.style.background = cor;
      s.innerText = txt;
      setTimeout(() => s.style.display = "none", 3000);
    }
    
    window.deletarDocumento = async () => {
      const id = document.getElementById('docId').value;
      const col = document.getElementById('colecaoAlvo').value;
      if(!id) return alert("Nenhum documento selecionado");
      if(!confirm("Tem certeza que deseja deletar este documento?")) return;
      
      setLoader(true, "DELETANDO...");
      try {
        await deleteDoc(doc(db, col, id));
        setLoader(false);
        mostrarStatus("DELETADO COM SUCESSO!", "var(--danger)");
        carregarListaCloud();
        location.reload();
      } catch (e) {
        setLoader(false);
        alert("Erro ao deletar");
      }
    };
    
    function coletarDadosFormulario() {
      return {
        ordem: parseInt(document.getElementById('ordemNoticia').value) || 0,
        titulo: document.getElementById('titulo').value,
        categoria: document.getElementById('categoria').value,
        resumo: document.getElementById('resumo').value,
        cor: document.getElementById('cor').value,
        linkArtigo: document.getElementById('linkArtigo').value,
        videoPrincipal: document.getElementById('videoPrincipal').value,
        capaNoticia: document.getElementById('capaNoticia').value,
        capaUrl: document.getElementById('capaUrl').value,
        capaDesc: document.getElementById('capaDesc').value,
        bannerAd: document.getElementById('bannerAd').value,
        linkPropagandaArtigo: document.getElementById('linkPropagandaArtigo').value,
        curtidas: parseInt(document.getElementById('curtidas').value) || 0,
        visualizacoes: parseInt(document.getElementById('visualizacoes').value) || 0,
        fichaCategoria: {
          perfilImg: document.getElementById('perfilImg').value,
          info: Array.from(document.querySelectorAll('#container-ficha-editor .item-flex')).map(el => ({ label: el.querySelector('.fe-label').value, valor: el.querySelector('.fe-valor').value }))
        },
        ficha: Array.from(document.querySelectorAll('#container-ficha .item-flex')).map(el => ({ label: el.querySelector('.f-label').value, valor: el.querySelector('.f-valor').value })),
        relacionados: Array.from(document.querySelectorAll('#container-relacionados > div')).map(el => ({ idVid: el.querySelector('.r-id').value, titulo: el.querySelector('.r-titulo').value, thumb: el.querySelector('.r-thumb').value })),
        produtos: Array.from(document.querySelectorAll('#container-produtos > div')).map(el => ({ nome: el.querySelector('.p-nome').value, link: el.querySelector('.p-link').value, img: el.querySelector('.p-img').value, desc: el.querySelector('.p-desc').value })),
        timestamp: Date.now()
      };
    }
    
    // Inicializa √≠cones Lucide
    lucide.createIcons();
    
    // Inicia
    setupAutoSave();
    carregarConfigAds();

    // Exporta para o escopo global as fun√ß√µes que precisam ser acessadas via onclick nos bot√µes din√¢micos
    window.prepararMigracaoMassa = prepararMigracaoMassa;
    window.executarMigracaoEmMassa = executarMigracaoEmMassa;
  </script>
</body>
</html>
